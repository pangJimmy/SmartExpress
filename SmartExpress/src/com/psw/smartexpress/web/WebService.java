package com.psw.smartexpress.web;

import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import org.ksoap2.SoapEnvelope;
import org.ksoap2.serialization.MarshalBase64;
import org.ksoap2.serialization.SoapObject;
import org.ksoap2.serialization.SoapSerializationEnvelope;
import org.ksoap2.transport.AndroidHttpTransport;
import org.xmlpull.v1.XmlPullParserException;

import com.psw.smartexpress.application.Mapplication;
import com.psw.smartexpress.util.Loger;


/**
 * 服务器请求
 * @author mac
 *
 */
public class WebService {
	
	public WebService(Mapplication mapp){
		URL_M = mapp.getURL() ;
	}

	//服务地址：http://123.56.138.171:2001/Services/e_Services.asmx
	
	public static  String SERVICE_NAME_SPACE = "http://tempuri.org/";
	
	public  String URL_M = "http://123.56.138.171:2001/Services/pda_Services.asmx" ;//服务器地址
	
	/**用户登陆***/
	private final String LOGIN = "userLoad" ;
	
	/**快递员收件***/
	private final String ADD_EXPRESS = "addExpress" ;
	
	/**快递员收件***/
	private final String GET_STATUES = "getStatus" ;
	
	/**快递员收件***/
	private final String PAI_EXPRESS = "paiExpress" ;
	
	/**快递员收件***/
	private final String GET_LLIST = "getLList" ;
	
	String tag = "WebService" ;
	
	String response ; //返回数据
	/**
	 * 1 登陆
	 * @param userName  用户名
	 * @param password  密码
	 * @param webCall
	 */
	public void login(String userName , String password, WebCallBack webCall) {
		response = null ;
		Map<String, String> map = new HashMap<>() ;
		map.put("username", userName) ;
		map.put("password", password) ;
		//发送请求
		response = sendRequest(map, LOGIN) ;
		//处理返回,1先获取错误码，2解析返回数据
		if(response != null && response.length() > 0){
			webCall.call(null, response) ;	
		}
	}
	
	/**
	 * 2 用户注册
	 * @param userName  用户名
	 * @param passWord  密码
	 * @param tel  电话
	 * @param email 邮箱
	 * @param webCall
	 */
	
	/**
	 * 发送web请求
	 * @return
	 */
	private String sendRequest(Map<String, String> paraMap , String methodName){
		String resp = null;
		// 实例化SoapObject对象,SERVICE_NAME_SPACE 命名空间  methodName 函数名称
		SoapObject request = new SoapObject(SERVICE_NAME_SPACE, methodName);
		//遍历参数
		if(paraMap != null && !paraMap.isEmpty()){
			Set<Entry<String, String>> set = paraMap.entrySet();  
			Iterator<Entry<String, String>> it = set.iterator(); 
			for(;it.hasNext();){  
			    Entry<String, String> entry = it.next();  
			    request.addProperty(entry.getKey(),entry.getValue())  ;
			    Loger.e(tag ,  "para : " + entry.getKey() + " = " + entry.getValue());  
			}
		}
		
		
		//获得序列化的Envelope第三步：设置SOAP请求信息(参数部分为SOAP协议版本号，与你要调用的webService中版本号一致):
		SoapSerializationEnvelope envelope = new SoapSerializationEnvelope(
				SoapEnvelope.VER11);
		envelope.bodyOut = request;
		// 第四步：注册Envelope,
		(new MarshalBase64()).register(envelope);
		// 第五步：构建传输对象，并指明WSDL文档URL：
		AndroidHttpTransport transport = new AndroidHttpTransport(
				URL_M);
//		HttpTransportSE transport = new HttpTransportSE(URL_M) ;
		transport.debug = true;
		//是否为dotNet编写的服务器
		envelope.dotNet = true ;
		try {
			// 第六步：调用WebService(其中参数为1：命名空间+方法名称，2：Envelope对象):
			transport.call(SERVICE_NAME_SPACE + methodName, envelope);
//			SoapObject obj = (SoapObject) envelope.bodyIn;
			SoapObject obj = (SoapObject) envelope.getResponse();
			resp = obj.getProperty(0).toString();
			Loger.e("resp", resp);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			

		} catch (IOException e) {
			// TODO Auto-generated catch block
//			e.printStackTrace();
			Loger.e(tag, e.toString()) ;
			resp = e.toString() ;
		} catch (XmlPullParserException e) {
			// TODO Auto-generated catch block
//			e.printStackTrace();
			Loger.e(tag, e.toString()) ;
			resp = e.toString() ;
		}
		return resp ;
	}
}
